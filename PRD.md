# MVP-W é¡¹ç›®æŠ€æœ¯æ¶æ„æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

**MVP-W (Minimum Viable Product - Watcher)** æ˜¯ä¸€ä¸ªè¾¹ç¼˜è®¾å¤‡ + äº‘ç«¯å¤§è„‘çš„æœ€å°å¯è¡Œç‰ˆæœ¬ã€‚

### æ ¸å¿ƒç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Watcher      â”‚      â”‚    Cloud           â”‚
â”‚   (ESP32-S3)      â”‚â—„â”€â”€â”€â”€â–ºâ”‚    (PC)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - éŸ³è§†é¢‘é‡‡é›†        â”‚      â”‚ - LLM åˆ†æ          â”‚
â”‚ - å±å¹•æ˜¾ç¤º/è¡¨æƒ…     â”‚      â”‚ - ASR è¯­éŸ³è¯†åˆ«      â”‚
â”‚ - æŒ‰é”®è¯­éŸ³è§¦å‘      â”‚      â”‚ - TTS è¯­éŸ³åˆæˆ      â”‚
â”‚ - WiFi/WebSocket   â”‚      â”‚ - Agent æ„å›¾ç†è§£    â”‚
â”‚ - UART â†’ MCU       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ UART
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCU (èº«ä½“)         â”‚
â”‚  (èˆµæœºæ§åˆ¶)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - èˆµæœº X/Y è½´      â”‚
â”‚ - LED çŠ¶æ€æŒ‡ç¤º      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠŸèƒ½è¾¹ç•Œ

| åŠŸèƒ½ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| **è¯­éŸ³é‡‡é›†** | Watcher | I2S éº¦å…‹é£ â†’ Opus ç¼–ç  â†’ WebSocket |
| **è¯­éŸ³æ’­æ”¾** | Watcher | WebSocket â† Opus è§£ç  â†’ I2S å–‡å­ |
| **è§†é¢‘é‡‡é›†** | Watcher | Himax æ‘„åƒå¤´ â†’ JPEG â†’ WebSocket |
| **å±å¹•æ˜¾ç¤º** | Watcher | LVGL UI + è¡¨æƒ…æ˜¾ç¤º |
| **æŒ‰é”®è§¦å‘** | Watcher | é•¿æŒ‰å¼€å§‹/ç»“æŸè¯­éŸ³è¾“å…¥ |
| **WiFi/é€šä¿¡** | Watcher | WiFi è¿æ¥ + WebSocket å®¢æˆ·ç«¯ |
| **è¿åŠ¨æ§åˆ¶** | MCU | GPIO PWM â†’ èˆµæœºäº‘å° |
| **LLM/Agent** | Cloud | Claude API / æœ¬åœ° LLM |
| **ASR/STT** | Cloud | è¯­éŸ³è½¬æ–‡å­— |
| **TTS** | Cloud | æ–‡å­—è½¬è¯­éŸ³ |

### æŠ€æœ¯å‚è€ƒ

- **Watcher SDK**: ä½¿ç”¨ Watcher-Firmware å®˜æ–¹ SDK (`sensecap-watcher`)
- **ESP32-MCU**: å‚è€ƒ WatcherOld/MCU æ¶æ„ (`main.c`)
- **ç¡¬ä»¶å‚æ•°**: å‚è€ƒ `Watcher-Firmware/examples/helloworld/local_components/sensecap-watcher/include/sensecap-watcher.h`

---

## ä¸€ã€ç¡¬ä»¶æ¶æ„

### 1.1 ç³»ç»Ÿæ¡†å›¾ (åŒESP32æ¶æ„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MVP-W ç³»ç»Ÿæ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚        Watcher           â”‚ WiFi â”‚         Cloud (PC)        â”‚   â”‚
â”‚   â”‚      (ESP32-S3)          â”‚â—„â”€â”€â”€â”€â–ºâ”‚                            â”‚   â”‚
â”‚   â”‚                          â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚  â”‚   WebSocket Server    â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  éŸ³é¢‘ Pipeline    â”‚ â”‚ åŒå‘æµâ”‚  â”‚   - éŸ³é¢‘æµæ¥æ”¶/å‘é€  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  - I2S éº¦å…‹é£    â”‚ â”‚      â”‚  â”‚   - è§†é¢‘æµæ¥æ”¶        â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  - Opus ç¼–ç      â”‚ â”‚      â”‚  â”‚   - æ§åˆ¶æŒ‡ä»¤ä¸‹å‘      â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  - Opus è§£ç      â”‚ â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚  â”‚  - I2S å–‡å­     â”‚ â”‚      â”‚              â”‚                â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚              â–¼                â”‚   â”‚
â”‚   â”‚                          â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚  â”‚   ASR (STT)           â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  Himax æ‘„åƒå¤´     â”‚ â”‚ â”€â”€â–º  â”‚  â”‚   è¯­éŸ³è¯†åˆ«             â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  (SPI)            â”‚ â”‚ JPEG â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚              â”‚                â”‚   â”‚
â”‚   â”‚                          â”‚      â”‚              â–¼                â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”‚  LVGL å±å¹•        â”‚ â”‚ â—„â”€â”€  â”‚  â”‚   LLM + Agent         â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  412x412 + è¡¨æƒ…   â”‚ â”‚ æ˜¾ç¤º â”‚  â”‚   æ„å›¾ç†è§£ + å†³ç­–     â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚                          â”‚      â”‚              â”‚                â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚              â–¼                â”‚   â”‚
â”‚   â”‚  â”‚  æŒ‰é”®è§¦å‘         â”‚ â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”‚  GPIO æ—‹é’®/æŒ‰é’®   â”‚ â”‚      â”‚  â”‚   TTS                  â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚  â”‚   è¯­éŸ³åˆæˆ             â”‚ â”‚   â”‚
â”‚   â”‚                          â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”‚  â”‚  WiFi + WebSocket â”‚ â”‚  â—„â”€â”€ é€šä¿¡æ ¸å¿ƒ                      â”‚
â”‚   â”‚  â”‚  (Station æ¨¡å¼)   â”‚ â”‚                                        â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                        â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                        â”‚
â”‚   â”‚  â”‚  UART è½¬å‘        â”‚ â”‚  â—„â”€â”€ è½¬å‘æ§åˆ¶æŒ‡ä»¤                    â”‚
â”‚   â”‚  â”‚  GPIO 19/20     â”‚ â”‚                                        â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚               â”‚ UART 115200                                        â”‚
â”‚               â”‚ (äº¤å‰è¿æ¥ TXâ†”RX)                                   â”‚
â”‚               â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚   â”‚         MCU              â”‚  â† èˆµæœºæ§åˆ¶                        â”‚
â”‚   â”‚    (ESP32 èº«ä½“)          â”‚                                    â”‚
â”‚   â”‚                          â”‚                                    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚   â”‚  â”‚  UART æ¥æ”¶        â”‚ â”‚  â† æ¥æ”¶ Watcher æŒ‡ä»¤                â”‚
â”‚   â”‚  â”‚  GPIO 19/20       â”‚ â”‚                                    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚   â”‚           â”‚            â”‚                                    â”‚
â”‚   â”‚           â–¼            â”‚                                    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚   â”‚  â”‚  èˆµæœºæ§åˆ¶         â”‚ â”‚  â† X/Y è½´ PWM                    â”‚
â”‚   â”‚  â”‚  - GPIO 12 (X)   â”‚ â”‚                                    â”‚
â”‚   â”‚  â”‚  - GPIO 13 (Y)   â”‚ â”‚                                    â”‚
â”‚   â”‚  â”‚  LEDC PWM 50Hz   â”‚ â”‚                                    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚   â”‚                          â”‚                                    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚   â”‚  â”‚  LED çŠ¶æ€æŒ‡ç¤º     â”‚ â”‚                                    â”‚
â”‚   â”‚  â”‚  GPIO 2           â”‚ â”‚                                    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Watcher GPIO åˆ†é…

> **å‚è€ƒ**: `Watcher-Firmware/examples/helloworld/local_components/sensecap-watcher/include/sensecap-watcher.h`

| GPIO | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| GPIO 10 | I2S MCLK | éŸ³é¢‘æ—¶é’Ÿ |
| GPIO 11 | I2S BCLK | ä½æ—¶é’Ÿ |
| GPIO 12 | I2S LRCK | å·¦å³å£°é“ |
| GPIO 15 | I2S DOUT | å–‡å­è¾“å‡º |
| GPIO 16 | I2S DIN | éº¦å…‹é£è¾“å…¥ |
| GPIO 4,5,6 | LCD SPI | æ˜¾ç¤ºå™¨ |
| GPIO 21 | Himax CS | æ‘„åƒå¤´ |
| GPIO 38,39 | Touch I2C | è§¦æ‘¸å± |
| GPIO 41,42 | æ—‹é’® Encoder | æŒ‰é’®è¾“å…¥ |
| GPIO 19 | UART0 TX | â†’ ESP32-MCU RX (GPIO 19) | å¤–éƒ¨å¼•è„šï¼Œçƒ§å½•æ—¶éœ€æ–­å¼€ |
| GPIO 20 | UART0 RX | â† ESP32-MCU TX (GPIO 20) | å¤–éƒ¨å¼•è„šï¼Œçƒ§å½•æ—¶éœ€æ–­å¼€ |

### 1.3 MCU GPIO åˆ†é…

> **å‚è€ƒ**: `WatcherOld/MCU/main/main.c`

| GPIO | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| GPIO 19 | UART TX | å‘é€å“åº” (â†’ S3 RX) |
| GPIO 20 | UART RX | æ¥æ”¶ Watcher æŒ‡ä»¤ (â† S3 TX) |
| GPIO 12 | èˆµæœº X è½´ | PWM è¾“å‡º |
| GPIO 13 | èˆµæœº Y è½´ | PWM è¾“å‡º |
| GPIO 2 | LED çŠ¶æ€ | æŒ‡ç¤ºç¯ |

### 1.4 é€šä¿¡æ¥å£

```
Cloud (PC)                 Watcher (S3)              MCU
â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€
:8766 (WS)  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º WiFi è¿æ¥

æ§åˆ¶æŒ‡ä»¤ (PC â†’ Watcher â†’ MCU):
{"type": "servo", "x": 90, "y": 45}  â”€â”€â”€â”€â”€â”€â–º  X:90\r\nY:45\r\n

TTS æ’­æ”¾ (PC â†’ Watcher):
{"type": "tts", "text": "ä½ å¥½"}  â”€â”€â–º éŸ³é¢‘æ’­æ”¾

å±å¹•æ˜¾ç¤º (PC â†’ Watcher):
{"type": "display", "text": "ä½ å¥½", "emoji": "happy"}

åª’ä½“æµ:
Opus Audio â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Opus Audio
JPEG Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º JPEG Image
```

---

## äºŒã€è½¯ä»¶æ¶æ„

### 2.1 Watcher æ¶æ„

> åŸºäº Watcher-Firmware å®˜æ–¹ SDK

```
Watcher Firmware (MVP-W)
â”‚
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ app_main.c              # å…¥å£ + ç³»ç»Ÿåˆå§‹åŒ–
â”‚   â”œâ”€â”€ ws_client.c             # WebSocket å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ audio_pipeline.c        # éŸ³é¢‘ pipeline
â”‚   â”‚   â”œâ”€â”€ i2s_capture_init() # éº¦å…‹é£åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ opus_encode()       # Opus ç¼–ç 
â”‚   â”‚   â”œâ”€â”€ opus_decode()       # Opus è§£ç 
â”‚   â”‚   â””â”€â”€ i2s_play_init()     # å–‡å­åˆå§‹åŒ–
â”‚   â”‚
â”‚   â”œâ”€â”€ button_voice.c          # æŒ‰é”®è¯­éŸ³è§¦å‘
â”‚   â”‚   â”œâ”€â”€ bsp_knob_btn_init() # æ—‹é’®æŒ‰é’®åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ long_press_start()  # é•¿æŒ‰å¼€å§‹å½•éŸ³
â”‚   â”‚   â””â”€â”€ long_release_stop()  # é•¿æŒ‰ç»“æŸå½•éŸ³
â”‚   â”‚
â”‚   â”œâ”€â”€ display_ui.c            # LVGL å±å¹•æ˜¾ç¤º
â”‚   â”‚   â”œâ”€â”€ bsp_lvgl_init()    # LVGL åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ show_text()        # æ˜¾ç¤ºæ–‡å­—
â”‚   â”‚   â””â”€â”€ show_emoji()        # æ˜¾ç¤ºè¡¨æƒ…
â”‚   â”‚
â”‚   â”œâ”€â”€ camera_capture.c        # Himax æ‹ç…§
â”‚   â”‚   â””â”€â”€ sscma_client_sample() # å›¾åƒé‡‡é›†
â”‚   â”‚
â”‚   â””â”€â”€ uart_bridge.c          # UART è½¬å‘åˆ° MCU
â”‚       â”œâ”€â”€ uart_init()        # UART åˆå§‹åŒ–
â”‚       â””â”€â”€ uart_forward()      # è½¬å‘æŒ‡ä»¤åˆ° MCU
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ sensecap-watcher        # ç¡¬ä»¶æŠ½è±¡ (å®˜æ–¹SDK)
â”‚   â”‚   â”œâ”€â”€ bsp_audio_init()  # éŸ³é¢‘åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ bsp_lvgl_init()   # LVGL åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ bsp_knob_btn_init() # æŒ‰é’®åˆå§‹åŒ–
â”‚   â”‚
â”‚   â”œâ”€â”€ sscma_client          # Himax é€šä¿¡
â”‚   â””â”€â”€ opus                   # Opus ç¼–è§£ç 
â”‚
â””â”€â”€ CMakeLists.txt
```

### 2.2 MCU æ¶æ„

> å‚è€ƒ WatcherOld/MCU æ¶æ„

```
MCU Firmware
â”‚
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ main.c                 # å…¥å£ + æ ¸å¿ƒé€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ uart_handler.c         # UART æŒ‡ä»¤å¤„ç†
â”‚   â”‚   â”œâ”€â”€ uart_init()       # UART2 åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ process_cmd()      # æŒ‡ä»¤è§£æ
â”‚   â”‚
â”‚   â”œâ”€â”€ servo_control.c        # èˆµæœºæ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ ledc_init()       # LEDC åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ set_angle()       # è®¾ç½®è§’åº¦
â”‚   â”‚   â””â”€â”€ smooth_move()     # å¹³æ»‘ç§»åŠ¨
â”‚   â”‚
â”‚   â””â”€â”€ bt_state.c            # çŠ¶æ€æŒ‡ç¤º
â”‚
â””â”€â”€ CMakeLists.txt
```

### 2.3 è¯­éŸ³è§¦å‘æµç¨‹

> æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šç¦»çº¿å”¤é†’è¯ + æŒ‰é”®è§¦å‘

#### 2.3.1 å”¤é†’è¯æ¨¡å¼ (æ¨è)

ä½¿ç”¨ä¹é‘« ESP-SR è¯­éŸ³è¯†åˆ«æ¡†æ¶ï¼Œå®ç°ç¦»çº¿å”¤é†’è¯æ£€æµ‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å”¤é†’è¯è§¦å‘æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ESP-SR è¯­éŸ³è¯†åˆ«æ¡†æ¶                       â”‚  â”‚
â”‚  â”‚   (è¿è¡Œåœ¨ Watcher ç«¯ï¼Œæ— éœ€ç½‘ç»œ)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  1. ç›‘å¬éº¦å…‹é£ (VAD æŒç»­æ£€æµ‹)                               â”‚
â”‚     â””â”€â”€ esp_sr_init() â†’ å¯åŠ¨è¯­éŸ³è¯†åˆ«                       â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  2. æ£€æµ‹å”¤é†’è¯ ("å°å¾®å°å¾®" / "ä½ å¥½å°å¾®")                   â”‚
â”‚     â””â”€â”€ esp_wn_register_callback() â†’ å›è°ƒ                  â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  3. å”¤é†’æˆåŠŸ â†’ æœ¬åœ°åé¦ˆ                                    â”‚
â”‚     â”œâ”€â”€ èˆµæœºå¾®åŠ¨ (æŠ¬å¤´/çœ¨çœ¼)                               â”‚
â”‚     â”œâ”€â”€ å±å¹•æ˜¾ç¤º "æˆ‘åœ¨å¬"                                  â”‚
â”‚     â””â”€â”€ èœ‚é¸£å™¨çŸ­å“                                         â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  4. å¼€å§‹å½•éŸ³ â†’ äº‘ç«¯ ASR                                    â”‚
â”‚     â””â”€â”€ åç»­æµç¨‹åŒæŒ‰é”®æ¨¡å¼ (è§ä¸‹æ–‡)                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å”¤é†’è¯é…ç½®:**

```c
// esp_wn_config.h
#define WAKENET_MODEL       "wn_model.bin"
#define WAKENET_KEYWORD     "ä½ å¥½å°å¾®"  // å¯è‡ªå®šä¹‰
#define DETECTION_THRESHOLD 0.8

// åˆå§‹åŒ–
esp_wn_handle_t wn_handle = NULL;
esp_wn_create(&wn_handle);
esp_wn_register_callback(wn_handle, wake_word_callback);
```

#### 2.3.2 æŒ‰é”®æ¨¡å¼ (å¤‡ç”¨)

å½“å”¤é†’è¯æœªå¯ç”¨æ—¶ï¼Œå¯ä½¿ç”¨æ—‹é’®æŒ‰é’®é•¿æŒ‰è§¦å‘ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŒ‰é”®è¯­éŸ³è§¦å‘æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. ç”¨æˆ·é•¿æŒ‰æ—‹é’®æŒ‰é’®                                         â”‚
â”‚     â””â”€â”€ bsp_knob_btn_init() â†’ æŒ‰é’®ä¸­æ–­                     â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  2. å¼€å§‹å½•éŸ³                                                 â”‚
â”‚     â””â”€â”€ bsp_i2s_read() â†’ PCM æ•°æ®                           â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  3. å®æ—¶ Opus ç¼–ç  â†’ WebSocket å‘é€                        â”‚
â”‚     â””â”€â”€ opus_encode() â†’ ws_send(audio)                     â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  4. ç”¨æˆ·æ¾å¼€æŒ‰é’®                                             â”‚
â”‚     â””â”€â”€ button_release äº‹ä»¶                                  â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  5. ç»“æŸå½•éŸ³ â†’ å‘é€ç»“æŸæ ‡è®°                                 â”‚
â”‚     â””â”€â”€ ws_send({type: "audio_end"})                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 å±å¹•æ˜¾ç¤ºä¸è¡¨æƒ…

> ä½¿ç”¨ Watcher-Firmware å®˜æ–¹ SDK ä¸­çš„ LVGL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å±å¹•æ˜¾ç¤ºæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  äº‘ç«¯å›å¤:                                                   â”‚
â”‚  {                                                          â”‚
â”‚    "type": "display",                                       â”‚
â”‚    "text": "ä½ å¥½å‘€!",                                       â”‚
â”‚    "emoji": "happy"                                         â”‚
â”‚  }                                                          â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  LVGL æ˜¾ç¤º                           â”‚                   â”‚
â”‚  â”‚  - æ˜¾ç¤ºæ–‡å­— (lv_label_set_text)      â”‚                   â”‚
â”‚  â”‚  - æ˜¾ç¤ºè¡¨æƒ…å›¾æ ‡ (lv_img)             â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                              â”‚
â”‚  æ”¯æŒçš„è¡¨æƒ…:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  happy â”‚  sad  â”‚ surprisedâ”‚ angry â”‚  normal â”‚          â”‚
â”‚  â”‚   ğŸ˜Š   â”‚   ğŸ˜¢   â”‚    ğŸ˜²    â”‚   ğŸ˜    â”‚   ğŸ˜    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 Cloud æ¶æ„

```
Cloud Backend (MVP-W-Server)
â”‚
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ websocket_server.py   # WebSocket æœåŠ¡
â”‚   â”œâ”€â”€ audio_handler.py      # éŸ³é¢‘æµå¤„ç†
â”‚   â”œâ”€â”€ video_handler.py      # è§†é¢‘æµå¤„ç†
â”‚   â””â”€â”€ control_handler.py   # æ§åˆ¶æŒ‡ä»¤
â”‚
â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ asr.py               # è¯­éŸ³è¯†åˆ« (å¯é€‰)
â”‚   â”œâ”€â”€ llm.py               # LLM æ¥å£
â”‚   â”œâ”€â”€ agent.py             # Agent é€»è¾‘
â”‚   â””â”€â”€ tts.py               # TTS æ¥å£
â”‚
â”œâ”€â”€ config.py                  # é…ç½®
â””â”€â”€ main.py                   # å…¥å£
```

---

## ä¸‰ã€é€šä¿¡åè®®

### 3.1 WebSocket æ¶ˆæ¯æ ¼å¼

#### 3.1.1 æ¶ˆæ¯ç±»å‹

```python
# æ¶ˆæ¯ç±»å‹æšä¸¾
class MessageType:
    # æ§åˆ¶æŒ‡ä»¤ (Cloud â†’ Watcher)
    SERVO_CONTROL = "servo"        # èˆµæœºæ§åˆ¶
    TTS_PLAY = "tts"              # è¯­éŸ³æ’­æ”¾
    DISPLAY_TEXT = "display"       # æ˜¾ç¤ºæ–‡å­—
    DISPLAY_IMAGE = "display_image" # æ˜¾ç¤ºå›¾åƒ
    GET_SENSOR = "get_sensor"     # è·å–ä¼ æ„Ÿå™¨
    STATUS = "status"             # çŠ¶æ€åé¦ˆ (AI æ€è€ƒä¸­/å›å¤ä¸­)
    REBOOT = "reboot"             # é‡å¯

    # åª’ä½“æµ (Watcher â†’ Cloud)
    AUDIO_STREAM = "audio"        # éŸ³é¢‘æµ
    VIDEO_STREAM = "video"        # è§†é¢‘æµ
    SENSOR_DATA = "sensor"         # ä¼ æ„Ÿå™¨æ•°æ®

    # çŠ¶æ€æ¶ˆæ¯ (åŒå‘)
    CONNECTED = "connected"
    ERROR = "error"
    PING = "ping"
    PONG = "pong"
```

#### 3.1.2 æ§åˆ¶æŒ‡ä»¤ (Cloud â†’ Watcher)

```json
// èˆµæœºæ§åˆ¶
{
    "type": "servo",
    "x": 90,
    "y": 45
}

// TTS æ’­æ”¾ (PC å‘é€éŸ³é¢‘æ•°æ®)
{
    "type": "tts",
    "format": "opus",
    "data": "<base64 encoded opus>"
}

// æ–‡å­—æ˜¾ç¤º
{
    "type": "display",
    "text": "ä½ å¥½",
    "size": 24
}

// æ‹ç…§è¯·æ±‚
{
    "type": "capture",
    "quality": 80
}

// çŠ¶æ€åé¦ˆ (AI æ€è€ƒä¸­/å›å¤ä¸­)
{
    "type": "status",
    "state": "thinking",
    "message": "æ­£åœ¨æ€è€ƒ..."
}

// çŠ¶æ€åé¦ˆ (AI å›å¤ä¸­)
{
    "type": "status",
    "state": "speaking",
    "message": "å›ç­”ä¸­..."
}
```

#### 3.1.3 åª’ä½“æµ (Watcher â†’ Cloud)

```json
// éŸ³é¢‘æµ
{
    "type": "audio",
    "format": "opus",
    "sample_rate": 16000,
    "data": "<base64 encoded opus>"
}

// è§†é¢‘æµ (JPEG)
{
    "type": "video",
    "format": "jpeg",
    "width": 412,
    "height": 412,
    "data": "<base64 encoded jpeg>"
}

// ä¼ æ„Ÿå™¨æ•°æ®
{
    "type": "sensor",
    "co2": 400,
    "temperature": 25.5,
    "humidity": 60
}
```

### 3.2 è¿æ¥æµç¨‹

```
PC Server                              ESP32 Client
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. å¯åŠ¨æœåŠ¡å™¨                            1. WiFi è¿æ¥
   ç›‘å¬ :8766
                                          2. WebSocket è¿æ¥
2. æ¥å—è¿æ¥        â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    ws://PC_IP:8766
3. å‘é€é…ç½®        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   {"type": "config", "sample_rate": 16000}

4. åŒå‘åª’ä½“æµä¼ è¾“ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   (æŒç»­)

5. æ§åˆ¶æŒ‡ä»¤       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   {"type": "servo", "x": 90}
```

---

## å››ã€åŠŸèƒ½æ¨¡å—

### 4.1 éŸ³é¢‘æ¨¡å— (Watcher)

#### 4.1.1 éŸ³é¢‘é‡‡é›†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  I2S éº¦å…‹é£  â”‚ â”€â”€â–º â”‚  PCM ç¼“å­˜   â”‚ â”€â”€â–º â”‚  Opus ç¼–ç   â”‚
â”‚  (16kHz)    â”‚     â”‚  (60mså¸§)   â”‚     â”‚  (60mså¸§)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ WebSocket   â”‚
                                      â”‚   å‘é€      â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.2 éŸ³é¢‘æ’­æ”¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocket   â”‚ â”€â”€â–º â”‚  Opus è§£ç   â”‚ â”€â”€â–º â”‚  I2S å–‡å­   â”‚
â”‚   æ¥æ”¶      â”‚     â”‚             â”‚     â”‚  (16kHz)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.3 å‚æ•°é…ç½®

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| é‡‡æ ·ç‡ | 16000 Hz | é€‚åˆè¯­éŸ³ |
| å¸§é•¿ | 60 ms | Opus æ¨è |
| ç¼–ç  | Opus | ä½å¸¦å®½ |
| æ¯”ç‰¹ç‡ | 16-32 kbps | å¯è°ƒ |

### 4.2 è§†é¢‘æ¨¡å— (Watcher)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Himax æ‘„åƒ  â”‚ â”€â”€â–º â”‚  JPEG ç¼–ç   â”‚ â”€â”€â–º â”‚ WebSocket   â”‚
â”‚ 412x412     â”‚     â”‚             â”‚     â”‚   å‘é€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| åˆ†è¾¨ç‡ | 412x412 | Himax æœ€å¤§ |
| æ ¼å¼ | JPEG | å‹ç¼©ä¼ è¾“ |
| å¸§ç‡ | ~5 fps | å—é™äºä¼ è¾“å¸¦å®½ |

### 4.3 è¿åŠ¨æ§åˆ¶æ¨¡å— (MCU)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocket   â”‚ â”€â”€â–º â”‚  æŒ‡ä»¤è§£æ   â”‚ â”€â”€â–º â”‚  LEDC PWM  â”‚
â”‚   æ¥æ”¶      â”‚     â”‚  X/Y è§’åº¦   â”‚     â”‚  èˆµæœºæ§åˆ¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```c
// èˆµæœºå‚æ•°
#define SERVO_FREQ     50      // 50Hz (20mså‘¨æœŸ)
#define SERVO_RES      13       // 13ä½åˆ†è¾¨ç‡
#define SERVO_MIN_US   500      // 0.5ms = 0Â°
#define SERVO_MAX_US   2500     // 2.5ms = 180Â°

// è§’åº¦åˆ° PWM è½¬æ¢
uint32_t angle_to_duty(int angle) {
    // angle: 0-180
    // return: duty (0-8191)
    return SERVO_MIN_US + (angle * (SERVO_MAX_US - SERVO_MIN_US) / 180);
}
```

### 4.4 AI æ€è€ƒçŠ¶æ€åé¦ˆ

å½“äº‘ç«¯ Agent æ­£åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œéœ€è¦å‘è®¾å¤‡åé¦ˆå½“å‰çŠ¶æ€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 AI æ€è€ƒçŠ¶æ€åé¦ˆæµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ç”¨æˆ·è¯´è¯                                                     â”‚
â”‚     â”‚                                                        â”‚
â”‚     â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  éŸ³é¢‘ä¸Šä¼ äº‘ç«¯    â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  å‘é€ status:   â”‚  â—„â”€â”€ å…³é”®: ç«‹å³åé¦ˆ                   â”‚
â”‚  â”‚  thinking       â”‚      é¿å…ç”¨æˆ·æ„Ÿåˆ°"æ­»æœº"               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Watcher ç«¯å“åº”                          â”‚   â”‚
â”‚  â”‚  - å±å¹•æ˜¾ç¤º "æ€è€ƒä¸­..." åŠ¨æ•ˆ                        â”‚   â”‚
â”‚  â”‚  - MCU èˆµæœºå¾®åŠ¨ (æŠ¬å¤´/æ™ƒè„‘)                       â”‚   â”‚
â”‚  â”‚  - å¯é€‰: èœ‚é¸£å™¨çŸ­å“æç¤º                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  LLM å¤„ç†å®Œæˆ    â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  å‘é€ status:   â”‚                                        â”‚
â”‚  â”‚  speaking       â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Watcher ç«¯å“åº”                          â”‚   â”‚
â”‚  â”‚  - å±å¹•æ˜¾ç¤ºå›å¤å†…å®¹ + è¡¨æƒ…                          â”‚   â”‚
â”‚  â”‚  - TTS æ’­æ”¾è¯­éŸ³                                     â”‚   â”‚
â”‚  â”‚  - èˆµæœºæ¢å¤åˆ°è‡ªç„¶å§¿æ€                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### çŠ¶æ€æšä¸¾

```python
class AgentState:
    IDLE = "idle"           # ç©ºé—²çŠ¶æ€
    THINKING = "thinking"   # AI æ€è€ƒä¸­
    SPEAKING = "speaking"   # AI å›å¤ä¸­
    ERROR = "error"         # é”™è¯¯çŠ¶æ€
```

#### Watcher ç«¯çŠ¶æ€å¤„ç†

```c
// status_handler.c
void handle_status_message(const char* state) {
    if (strcmp(state, "thinking") == 0) {
        // æ˜¾ç¤ºæ€è€ƒä¸­åŠ¨æ•ˆ
        lv_anim_start(&thinking_animation);

        // èˆµæœºå¾®åŠ¨ - æŠ¬å¤´
        uart_send_cmd("X:85\r\nY:60\r\n");  // è½»å¾®æŠ¬å¤´
    }
    else if (strcmp(state, "speaking") == 0) {
        // åœæ­¢æ€è€ƒåŠ¨æ•ˆ
        lv_anim_stop(&thinking_animation);

        // èˆµæœºæ¢å¤è‡ªç„¶å§¿æ€
        uart_send_cmd("X:90\r\nY:90\r\n");
    }
    else if (strcmp(state, "idle") == 0) {
        // æ¢å¤å¾…æœºçŠ¶æ€
        uart_send_cmd("X:90\r\nY:90\r\n");
    }
}
```

#### MCU ç«¯å¾®åŠ¨å“åº”

```c
// mcu_servo.c
void servo_subtle_move() {
    // è½»å¾®æŠ¬å¤´åŠ¨ä½œ (15-30åº¦èŒƒå›´)
    int current_y = servo_get_position(Y_AXIS);
    int target_y = current_y + (random() % 30 - 15);

    // å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
    servo_smooth_move(Y_AXIS, target_y, 500);  // 500ms ç§»åŠ¨

    // è½»å¾®å·¦å³æ™ƒåŠ¨
    vTaskDelay(pdMS_TO_TICKS(300));
    servo_smooth_move(X_AXIS, 90 + (random() % 20 - 10), 300);
}
```

### 4.5 Cloud æ¨¡å—

#### 4.5.1 WebSocket æœåŠ¡å™¨

```python
class WatcherServer:
    def __init__(self, host='0.0.0.0', port=8766):
        self.clients = set()

    async def handle_websocket(self, websocket):
        self.clients.add(websocket)
        try:
            async for message in websocket:
                await self.process_message(message)
        finally:
            self.clients.remove(websocket)

    async def process_message(self, message):
        data = json.loads(message)
        msg_type = data.get('type')

        if msg_type == 'audio':
            await self.handle_audio(data)
        elif msg_type == 'video':
            await self.handle_video(data)
        elif msg_type == 'servo':
            await self.handle_servo(data)
```

#### 4.5.2 LLM Agent é›†æˆ

```python
class Agent:
    def __init__(self, llm_provider='claude'):
        self.llm = LLMProvider(llm_provider)
        self.tools = self.register_tools()

    async def process(self, audio_data):
        # 1. ASR (è¯­éŸ³è½¬æ–‡å­—)
        text = await self.asr.transcribe(audio_data)

        # 2. Agent æ¨ç†
        response = await self.llm.chat(
            messages=[{"role": "user", "content": text}],
            tools=self.tools
        )

        # 3. æ‰§è¡ŒåŠ¨ä½œ
        for tool_call in response.tool_calls:
            await self.execute_tool(tool_call)

        # 4. TTS (æ–‡å­—è½¬è¯­éŸ³)
        if response.should_speak:
            audio = await self.tts.synthesize(response.text)
            await self.send_to_esp32(audio, 'tts')
```

---

## äº”ã€å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€é€šä¿¡ (10h)

- [ ] ESP32 WebSocket å®¢æˆ·ç«¯
- [ ] PC WebSocket æœåŠ¡å™¨
- [ ] åŒå‘æ–‡æœ¬æ¶ˆæ¯é€šä¿¡
- [ ] è¿æ¥çŠ¶æ€ç®¡ç†
- [ ] **å¯é æ€§æœºåˆ¶**
  - [ ] çœ‹é—¨ç‹— (Watchdog) é…ç½®
  - [ ] WebSocket è‡ªåŠ¨é‡è¿
  - [ ] å¼‚å¸¸æ—¥å¿—è¾“å‡º

### Phase 2: éŸ³é¢‘é€šè·¯ (10h)

- [ ] ESP32 I2S éº¦å…‹é£é‡‡é›†
- [ ] ESP32 Opus ç¼–ç 
- [ ] PC ç«¯ Opus è§£ç 
- [ ] PC ç«¯éŸ³é¢‘å½•åˆ¶æµ‹è¯•

### Phase 3: äº‘ç«¯ AI é›†æˆ (10h)

- [ ] Python ASR æ¥å£ (Whisper ç­‰)
- [ ] Python LLM æ¥å£ (Claude/OpenAI)
- [ ] Agent é€»è¾‘
- [ ] TTS æ¥å£

### Phase 4: æ§åˆ¶é—­ç¯ (10h)

- [ ] èˆµæœºæ§åˆ¶æŒ‡ä»¤
- [ ] TTS æ’­æ”¾é€šè·¯
- [ ] è§†é¢‘é‡‡é›† (å¯é€‰)
- [ ] æ•´ä½“è”è°ƒ

---

## å…­ã€å…³é”®æ–‡ä»¶

| æ¨¡å— | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| ESP32 å…¥å£ | `firmware/main/app_main.c` | ç³»ç»Ÿåˆå§‹åŒ– |
| WS å®¢æˆ·ç«¯ | `firmware/main/ws_client.c` | é€šä¿¡æ ¸å¿ƒ |
| éŸ³é¢‘ pipeline | `firmware/main/audio_pipeline.c` | éŸ³è§†é¢‘å¤„ç† |
| èˆµæœºæ§åˆ¶ | `firmware/main/servo_control.c` | è¿åŠ¨æ§åˆ¶ |
| PC æœåŠ¡å™¨ | `server/websocket_server.py` | äº‘ç«¯å…¥å£ |
| Agent | `server/ai/agent.py` | AI é€»è¾‘ |

---

## ä¸ƒã€é…ç½®è¯´æ˜

### 7.1 Watcher é…ç½®

```c
// wifi_config.h
#define WIFI_SSID "YourSSID"          // å¯é€šè¿‡ NVS è¦†ç›–
#define WS_SERVER_URL "ws://192.168.1.100:8766"

// æ¨è: ä½¿ç”¨ NVS å­˜å‚¨ WiFi å¯†ç  (è§ç¬¬åç« å®‰å…¨è®¾è®¡)
// #include "wifi_nvs.h"  // è‡ªå®šä¹‰ç»„ä»¶å­˜å‚¨å‡­è¯
```

### 7.2 Cloud é…ç½®

```python
# config.py
class Config:
    WS_HOST = "0.0.0.0"
    WS_PORT = 8766

    # LLM é…ç½®
    LLM_PROVIDER = "claude"  # æˆ– "openai"
    LLM_API_KEY = "sk-..."

    # ASR é…ç½® (å¯é€‰)
    ASR_PROVIDER = "whisper"

    # TTS é…ç½® (å¯é€‰)
    TTS_PROVIDER = "elevenlabs"
```

---

## ç¼–è¯‘ä¸çƒ§å½•ç¯å¢ƒ

### 7.1 Watcher å¼€å‘ç¯å¢ƒ

#### è½¯ä»¶è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| ESP-IDF | v5.2+ | å®˜æ–¹ SDK |
| Python | 3.8+ | æ„å»ºå·¥å…· |
| CMake | 3.16+ | æ„å»ºç³»ç»Ÿ |
| Ninja | 1.10+ | æ„å»ºåŠ é€Ÿ |

#### ç¡¬ä»¶è¦æ±‚

| è®¾å¤‡ | è¯´æ˜ |
|------|------|
| USB ä¸²å£é©±åŠ¨ | CH340/CP2102 |
| USB æ•°æ®çº¿ | æ”¯æŒæ•°æ®é€šä¿¡ |
| æœé‚¦çº¿ | è¿æ¥ ESP32-MCU |

#### å®‰è£…æ­¥éª¤

```bash
# 1. å…‹éš† ESP-IDF
git clone -b v5.2.1 --recursive https://github.com/espressif/esp-idf.git
cd esp-idf
./install.sh esp32s3

# 2. æ¿€æ´»ç¯å¢ƒ (Windows)
.\env.ps1

# 3. è¿›å…¥é¡¹ç›®ç›®å½•
cd MVP-W/firmware/s3

# 4. è®¾ç½®ç›®æ ‡èŠ¯ç‰‡
idf.py set-target esp32s3

# 5. é…ç½®é¡¹ç›®
idf.py menuconfig
# éœ€è¦å¯ç”¨:
# - PSRAM
# - WiFi
# - WebSocket
# - I2S

# 6. ç¼–è¯‘
idf.py build

# 7. çƒ§å½• (Windows COM å£)
idf.py -p COM3 flash monitor

# 8. ç›‘è§†æ—¥å¿—
idf.py -p COM3 monitor
```

#### æ³¨æ„äº‹é¡¹

- **GPIO 19/20**: çƒ§å½•æ—¶éœ€æ–­å¼€ä¸ ESP32-MCU çš„è¿æ¥ï¼Œå¦åˆ™ä¼šå¹²æ‰°çƒ§å½•
- **åˆ†åŒºè¡¨**: ä½¿ç”¨é»˜è®¤ `singleapp` åˆ†åŒºï¼Œæˆ–è‡ªå®šä¹‰ `nvs` + `app` + `spiffs`
- **PSRAM**: å»ºè®®å¯ç”¨ä»¥æ”¯æŒéŸ³é¢‘ç¼“å†²åŒº

---

### 7.2 MCU å¼€å‘ç¯å¢ƒ

#### è½¯ä»¶è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| ESP-IDF | v5.2+ | åŒä¸»æ§ |
| Python | 3.8+ | æ„å»ºå·¥å…· |

#### ç¡¬ä»¶è¿æ¥

```
ESP32-S3 (ä¸»æ§)          ESP32-MCU (èº«ä½“)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GPIO 19 (TX)   â”€â”€â”€â”€â”€â”€â”€â–º  GPIO 20 (RX)
GPIO 20 (RX)  â—„â”€â”€â”€â”€â”€â”€â”€   GPIO 19 (TX)
GND           â”€â”€â”€â”€â”€â”€â”€â–º   GND
```

#### ç¼–è¯‘ä¸çƒ§å½•

```bash
# 1. è¿›å…¥ MCU é¡¹ç›®
cd MVP-W/firmware/mcu

# 2. è®¾ç½®ç›®æ ‡èŠ¯ç‰‡
idf.py set-target esp32

# 3. ç¼–è¯‘
idf.py build

# 4. çƒ§å½• (Windows COM å£)
idf.py -p COM4 flash monitor
```

#### æ³¨æ„äº‹é¡¹

- **æ³¢ç‰¹ç‡**: UART é€šä¿¡ä½¿ç”¨ 115200
- **èˆµæœº PWM**: GPIO 12 (Xè½´), GPIO 13 (Yè½´)
- **ç‹¬ç«‹ä¾›ç”µ**: èˆµæœºå¯èƒ½éœ€è¦å¤–éƒ¨ 5V ä¾›ç”µ

---

### 7.3 Cloud å¼€å‘ç¯å¢ƒ

#### è½¯ä»¶è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| Python | 3.9+ | è¿è¡Œç¯å¢ƒ |
| pip | 21.0+ | åŒ…ç®¡ç† |
| FFmpeg | latest | éŸ³é¢‘å¤„ç† |

#### ä¾èµ–å®‰è£…

```bash
# è¿›å…¥æœåŠ¡å™¨ç›®å½•
cd MVP-W/server

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (æ¨è)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
.\venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

#### è¿è¡ŒæœåŠ¡å™¨

```bash
# å¯åŠ¨ WebSocket æœåŠ¡å™¨
python main.py

# æˆ–æŒ‡å®šç«¯å£
python main.py --host 0.0.0.0 --port 8766

# å‚æ•°è¯´æ˜:
# --host: ç›‘å¬åœ°å€ (é»˜è®¤ 0.0.0.0)
# --port: ç›‘å¬ç«¯å£ (é»˜è®¤ 8766)
# --debug: è°ƒè¯•æ¨¡å¼
```

---

## ä¹ã€å¯é æ€§è®¾è®¡

### 9.1 çœ‹é—¨ç‹— (Watchdog)

Watcher éœ€å¯ç”¨ç¡¬ä»¶çœ‹é—¨ç‹—ï¼Œé˜²æ­¢å›ºä»¶æ­»é”ï¼š

```c
// app_main.c
#include "esp_task_wdt.h"

void app_main() {
    // åˆå§‹åŒ–çœ‹é—¨ç‹— (30ç§’è¶…æ—¶)
    esp_task_wdt_init(30, true);
    esp_task_wdt_add(NULL);

    // ä¸»å¾ªç¯ä¸­å®šæœŸå–‚ç‹—
    while (1) {
        // ... ä¸šåŠ¡é€»è¾‘
        esp_task_wdt_reset();  // å–‚ç‹—
    }
}
```

### 9.2 WebSocket é‡è¿æœºåˆ¶

```c
// ws_client.c
static TaskHandle_t reconnect_task_handle = NULL;

void ws_start_reconnect_task() {
    if (reconnect_task_handle == NULL) {
        xTaskCreate(ws_reconnect_task, "ws_reconnect", 4096, NULL, 5, &reconnect_task_handle);
    }
}

void ws_reconnect_task(void *param) {
    while (!ws_is_connected()) {
        ESP_LOGI(TAG, "å°è¯•é‡æ–°è¿æ¥ WebSocket...");
        esp_ws_connect();
        vTaskDelay(pdMS_TO_TICKS(5000));  // 5ç§’é‡è¯•
    }
    vTaskDelete(NULL);
}
```

### 9.3 å¼‚å¸¸æ—¥å¿—

```c
#include "esp_log.h"
#include "esp_system.h"

void esp_restart(void) __attribute__((noreturn));

void handle_crash() {
    esp_reset_reason_t reason = esp_reset_reason();
    ESP_LOGE(TAG, "ç³»ç»Ÿé‡å¯åŸå› : %d", reason);

    // è¾“å‡ºå´©æºƒå‰çš„çŠ¶æ€
    ESP_LOGI(TAG, "Free heap: %lu", esp_get_free_heap_size());
    ESP_LOGI(TAG, "Min free heap: %lu", esp_get_minimum_free_heap_size());

    esp_restart();
}
```

---

## åã€æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œè¦æ±‚**: ESP32 å’Œ PC éœ€è¦åœ¨åŒä¸€å±€åŸŸç½‘
2. **å»¶è¿Ÿ**: WebSocket ä¼ è¾“æœ‰ 100-200ms å»¶è¿Ÿ
3. **å¸¦å®½**: éŸ³é¢‘ ~16kbps, è§†é¢‘ ~100kbps
4. **å®‰å…¨**: ç”Ÿäº§ç¯å¢ƒéœ€è¦ TLS åŠ å¯†

---

*æ–‡æ¡£ç‰ˆæœ¬: 2.0*
*åˆ›å»ºæ—¥æœŸ: 2026-02-26*
