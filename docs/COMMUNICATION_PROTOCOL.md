# MVP-W 通讯协议文档 v2.0

> 文档日期：2026-03-01
> 状态：已确认
> 更新：统一消息格式，简化二进制帧

## 1. 系统架构

```
┌─────────────────────┐      WebSocket      ┌─────────────────────┐
│   Watcher (S3)      │◄──────────────────►│   Cloud (PC)        │
│   ESP32-S3          │   ws://IP:8766     │   Python Server     │
├─────────────────────┤                    ├─────────────────────┤
│ - 音频采集/播放     │                    │ - ASR (语音识别)    │
│ - 屏幕显示/表情     │                    │ - LLM (Claude)      │
│ - 按键语音触发      │                    │ - TTS (语音合成)    │
│ - UART → MCU        │                    │ - Agent 调度        │
└─────────┬───────────┘                    └─────────────────────┘
          │ UART 115200
          ▼
┌─────────────────────┐
│  MCU (身体)         │
│  ESP32 舵机控制     │
├─────────────────────┤
│ - 舵机 X/Y 轴       │
│ - LED 状态指示      │
└─────────────────────┘
```

## 2. 统一消息格式

### 2.1 JSON 文本消息

所有 JSON 文本消息采用统一格式：

```json
{
  "type": "消息类型",
  "code": 0,
  "data": "消息数据"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| type | string | 消息类型 |
| code | int | 状态码，`0` 表示成功，`1` 表示错误 |
| data | any | 消息数据，可以是 string、object 等 |

### 2.2 二进制消息

- **TTS 音频** (Cloud → Watcher)：原始 PCM，24kHz，16-bit，mono
- **语音音频** (Watcher → Cloud)：原始 PCM，16kHz，16-bit，mono

---

## 3. 服务端 → 客户端消息

### 3.1 ASR 识别结果 (asr_result)

语音识别完成后的文本结果。

```json
{"type": "asr_result", "code": 0, "data": "识别到的文本内容"}
```

**Watcher 处理**：
- 显示识别文本
- 切换到 analyzing 动画

---

### 3.2 Bot 回复 (bot_reply)

AI 对话返回的回复文本。

```json
{"type": "bot_reply", "code": 0, "data": "AI 回复内容"}
```

**Watcher 处理**：
- 可选：显示回复文本
- 准备接收 TTS 音频

---

### 3.3 状态消息 (status)

系统状态变化通知。

```json
{"type": "status", "code": 0, "data": "状态描述信息"}
```

**示例场景**：
- `[thinking] 正在思考...` - AI 思考中
- `舵机动画开始: speech_nod` - 舵机动画状态

**Watcher 处理**：
- 解析状态内容
- 更新屏幕显示和动画

---

### 3.4 错误消息 (error)

系统错误或异常信息。

```json
{"type": "error", "code": 1, "data": "错误描述信息"}
```

**Watcher 处理**：
- 显示错误状态
- 切换到 sad 动画

---

### 3.5 舵机控制 (servo)

实时舵机角度数据。

```json
{"type": "servo", "code": 0, "data": {"x": 90, "y": 45}}
```

| 字段 | 类型 | 范围 | 说明 |
|------|------|------|------|
| x | int | 0-180 | X 轴角度，控制左右 |
| y | int | 0-180 | Y 轴角度，控制上下 |

**Watcher 处理流程**：
```
ws_router → on_servo_handler() → uart_bridge_send_servo(x, y)
                                     ↓
                              UART: "X:90\r\nY:45\r\n"
```

---

### 3.6 TTS 音频结束 (tts_end)

TTS 语音合成完成，所有音频数据已发送完毕。

```json
{"type": "tts_end", "code": 0, "data": "ok"}
```

**Watcher 处理**：
- 等待 I2S 缓冲区播放完毕 (~500ms)
- 停止音频播放
- 切换到 happy 动画

---

### 3.7 TTS 音频数据 (二进制)

TTS 合成的音频数据，直接发送二进制内容。

- **消息类型**：二进制（非 JSON）
- **数据格式**：原始 PCM（无帧头）
- **采样率**：24000 Hz
- **位深**：16-bit signed
- **声道**：mono

**Watcher 处理**：
```
WebSocket 二进制消息 → 直接写入 I2S 播放
```

---

## 4. 客户端 → 服务端消息

### 4.1 语音音频数据 (二进制)

客户端发送的 PCM 音频流数据。

- **消息类型**：二进制
- **数据格式**：原始 PCM（无帧头）
- **采样率**：16000 Hz
- **位深**：16-bit signed
- **声道**：mono

---

### 4.2 结束标记 (over)

客户端发送结束标记，表示音频数据已发送完毕。

```
over
```

> **注意**：这是纯文本字符串，不是 JSON 格式。

---

### 4.3 舵机动画控制 (servo)

控制舵机动画的播放。

```json
// 开始播放动画
{"type": "servo", "action": "start", "state": "speech_nod"}

// 停止动画
{"type": "servo", "action": "stop"}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| action | string | 操作类型：`start` 播放动画，`stop` 停止动画 |
| state | string | 动画状态名（仅 start 时需要） |

**可用动画状态**：
- `speech_nod` - 说话点头动画

---

## 5. 消息流程示例

### 5.1 完整语音对话流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 客户端 (Watcher)                  服务端 (Cloud)                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ─── 二进制音频数据 ─────────────────────────────────────────►  │
│  ─── "over" ─────────────────────────────────────────────────►  │
│                                                                 │
│  ◄── {"type":"asr_result","code":0,"data":"今天天气"} ───────   │
│  ◄── {"type":"bot_reply","code":0,"data":"今天天气晴朗..."} ─   │
│                                                                 │
│  ◄── 二进制 TTS 音频 (PCM 24kHz) ────────────────────────────   │
│  ◄── {"type":"servo","code":0,"data":{"x":95,"y":90}} ───────   │
│  ◄── {"type":"servo","code":0,"data":{"x":100,"y":90}} ──────   │
│  ...                                                            │
│  ◄── {"type":"tts_end","code":0,"data":"ok"} ────────────────   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 舵机动画控制流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 客户端 (Watcher)                  服务端 (Cloud)                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ─── {"type":"servo","action":"start","state":"speech_nod"} ─►  │
│  ◄── {"type":"status","code":0,"data":"舵机动画开始: speech_nod"}│
│  ◄── {"type":"servo","code":0,"data":{"x":95,"y":90}} ───────   │
│  ◄── {"type":"servo","code":0,"data":{"x":96,"y":90}} ───────   │
│  ...                                                            │
│                                                                 │
│  ─── {"type":"servo","action":"stop"} ───────────────────────►  │
│  ◄── {"type":"status","code":0,"data":"舵机动画已停止"} ──────   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. UART 协议 (Watcher → MCU)

**格式**：`<axis>:<angle>\r\n`

**示例**：
```
X:90\r\n
Y:90\r\n
```

**说明**：
- `axis`: 轴标识，`X` 或 `Y`
- `angle`: 角度值 (0-180)
- 每条指令以 `\r\n` 结尾

---

## 7. 表情/动画映射

| emoji 值 | 动画类型 | 使用场景 |
|----------|---------|---------|
| `happy` | GREETING | 欢迎状态、正常待机 |
| `sad` / `error` | DETECTED | 错误、遗憾 |
| `surprised` | DETECTING | 检测到异常 |
| `angry` | ANALYZING | 警告状态 |
| `standby` / `normal` / `idle` | STANDBY | 默认状态 |
| `listening` | LISTENING | 录音中 |
| `analyzing` / `thinking` | ANALYZING | AI 处理中 |
| `speaking` | LISTENING (temp) | TTS 播放中 |

---

## 8. 音频参数汇总

| 方向 | 用途 | 采样率 | 格式 | 帧格式 |
|------|------|--------|------|--------|
| Watcher → Cloud | 语音上传 | 16kHz | 16-bit PCM mono | 原始 PCM |
| Cloud → Watcher | TTS 播放 | 24kHz | 16-bit PCM mono | 原始 PCM |

**带宽计算**：
- 上传：16000 × 2 × 1 = 32 KB/s = 256 kbps
- 下载：24000 × 2 × 1 = 48 KB/s = 384 kbps

---

## 9. 状态流转图

```
┌─────────┐  按下按钮   ┌───────────┐  松开按钮   ┌──────────┐
│ STANDBY │ ─────────► │ LISTENING │ ─────────► │ANALYZING │
└────┬────┘            └───────────┘            └────┬─────┘
     │                                                │
     │ WS断开                      收到 tts_end      │
     ▼                                                ▼
┌──────────┐                                   ┌────────────┐
│ STANDBY  │                                   │  HAPPY     │
│(屏幕提示)│                                   │ (播放完成) │
└──────────┘                                   └────────────┘
```

---

*文档版本：2.0*
*更新日期：2026-03-01*

## 变更历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 2.0 | 2026-03-01 | **协议重构** - 统一消息格式，简化二进制帧（去除 AUD1 头），新增 asr_result/bot_reply/tts_end 消息类型 |
| 1.1 | 2026-02-28 | 音频格式从 Opus 改为 PCM 直传 |
| 1.0 | 2026-02-28 | 初始版本 |
